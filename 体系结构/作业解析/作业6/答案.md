# MESI 协议题目标准答案

---

## 题目 (a)：哪个 cache line 状态发生了不一致？

**答案**：

**Set 1，Tag = 0x511100** 的 cache line 发生了不一致。

- Cache 2：状态为 **E (Exclusive)**
- Cache 3：状态为 **S (Shared)**

**原因**：根据 MESI 协议，E 状态要求独占（其他 Cache 必须为 I），不能与 S 状态共存。这违反了协议规则，说明其中一个状态位被宇宙射线翻转。

---

## 题目 (b)：该执行序列是否会导致错误结果？

**答案**：**会**

**分析**：

地址 `0x51110040`：Index = 1（bit 7-6 = 01），Tag = 0x511100

第 1 步：P2 执行 `ld 0x51110040`
- 若宇宙射线将 Cache 2 Set 1 从 **I → E** 翻转
- P2 看到状态为 E（有效），直接读取本地 Cache
- 实际读到的是**无效的垃圾数据**

**结论**：程序读取错误数据，导致错误结果。

---

## 题目 (c)：该执行序列是否会导致错误结果？

**答案**：**会**

**分析**：

第 1 步：P3 执行 `ld 0x51110040`
- 若宇宙射线将 Cache 3 Set 1 从 **I → S** 翻转
- P3 看到状态为 S（有效），直接读取本地 Cache
- 实际读到的是**无效的垃圾数据**

**结论**：程序读取错误数据，导致错误结果。

---

## 题目 (d)：最少指令序列达成目标状态

**差异分析**：

| Set | 变化 | 需要操作 |
|:---:|:---|:---|
| Set 0 | C3: E → M | P3 写该地址 |
| Set 1 | 无变化 | **不可触碰**（保持非法状态） |
| Set 3 | C0: I → E，C1/C2: S → I | P0 先写旧地址踢掉 S，再读新地址获得 E |

**地址计算**：
- Set 0 地址（Tag=0x5FF000，Index=00）：`0x5FF00000`
- Set 3 旧地址（Tag=0x533333，Index=11）：`0x533333C0`
- Set 3 新地址（Tag=0x5FFFFF，Index=11）：`0x5FFFFFC0`

**答案（3 条指令）**：

| 顺序 | 处理器 | 操作 | 地址 | 作用 |
|:---:|:---:|:---:|:---:|:---|
| 1 | P3 | st | 0x5FF00000 | C3 Set0: E → M |
| 2 | P0 | st | 0x533333C0 | C1/C2 Set3: S → I |
| 3 | P0 | ld | 0x5FFFFFC0 | C0 Set3: I → E |